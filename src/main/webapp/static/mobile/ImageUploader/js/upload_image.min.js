function Wrapper(b){var a=document.body.scrollHeight>window.screen.availHeight?document.body.scrollHeight+"px":window.screen.availHeight+"px";this.config=$.extend({},{zIndex:100,opacity:0.5,width:"100%",height:a,top:0,background:"#000"},b||{}),this.$wrapper=$("#J_wrapper").length>0?$("#J_wrapper"):function(){return $("body").append($('<div id="J_wrapper"></div>')),$("#J_wrapper")}(),$.extend(Wrapper.prototype,{show:function(d){var c=this;return $("body").css("overflow","hidden"),c.$wrapper.css({position:"absolute",opacity:c.config.opacity,background:c.config.background,zIndex:c.config.zIndex,top:c.config.top,width:c.config.width,height:c.config.height}),$.isFunction(d)&&d.call(c),c.$wrapper},close:function(){this.$wrapper.remove(),$("body").css("overflow","auto")}})}function ImageUploader(c,j){var g=function(l,k){var m=this;m.config=$.extend({},{inputName:"img",onlyShow:!1,uploadBtn:".J_UploadBtn",fileInput:".J_FileInput",prevClass:"preview",quality:0.8,qualityIOS:0,maxWidth:0,maxHeight:0,uploaderUrl:"",deleteImage:true,deleteUrl:"",limitSize:5,limitNum:1,beforeComplete:function(n){},afterComplete:function(){},afterDeleteImageComplete:function(){}},k),m.file=null,m.$controller=l,m.$uploadBtn=l.find(m.config.uploadBtn);m.$fileInput=l.find(m.config.fileInput);m.$uploadBtn.css({overflow:"hidden"});m.$uploadBtn.on("click",function(){m.$fileInput.focus()});$(".upload-area").on("click","img",function(){d(m,this.dataset.url,"img_"+this.dataset.fileid,this.dataset.fileid,m.config.deleteImage)});return m.uploadImage()};$.extend(g.prototype,{compressImage:function(o,n){var m=this;if(!o){return}n=n||function(){};var l=document.createElement("canvas");var k=new Image();k.onload=function(){var q=l.getContext("2d");q.clearRect(0,0,l.width,l.height);var s=m.config.maxWidth||k.width;var r=m.config.maxHeight||k.height;if(k.width>s||k.height>r){var p=Math.max(k.width/s,k.height/r);l.width=k.width/p;l.height=k.height/p}else{l.width=k.width;l.height=k.height}q.drawImage(k,0,0,k.width,k.height,0,0,l.width,l.height);n(l.toDataURL("image/jpeg",m.config.quality||1))};k.src=o},uploadImage:function(){var l=this;function k(m){if(m.length/1024/1400>=l.config.limitSize){l.$fileInput.val("");alert("上传文件太大");return}var n=$("<img>"),p=(new Date).getTime();var o="";l.$uploadBtn.addClass("loading");$.ajax({type:"post",url:l.config.uploaderUrl,data:{base64Data:m},dataType:"json",cache:!1,success:function(s){var r=s.obj["url"];var q=s.obj["id"];n[0].onload=function(){var u="img_"+q;var t=$("img.preview").length;l.$uploadBtn.before(n.addClass("small").addClass(l.config.prevClass).addClass(u));l.$uploadBtn.before('<input type="hidden" name="'+l.config.inputName+'" data-index="'+t+'" class="'+u+'" value="'+q+'">');n.attr("data-url",r);n.attr("data-fileid",q);n.on("click",function(){d(l,this.dataset.url,u,s.obj["id"],l.config.deleteImage)});l.$uploadBtn.removeClass("loading");l.config.afterComplete.call(l)};n[0].src=r},error:function(){},complete:function(){}})}l.$fileInput.on("change",function(p){if(l.$uploadBtn.siblings("."+l.config.prevClass).length>=l.config.limitNum){l.$fileInput.val("");alert("最多可上传: "+i.config.limitNum+"张");return}var q=l.file=p.target.files[0];var o=l.config.beforeComplete.call(l,q);if(o!=undefined&&o==false){return}if(l.file){var m=new FileReader;m.onloadend=function(n){if(b()){f(l,n.target.result,k)}else{l.compressImage(n.target.result,k)}};m.readAsDataURL(l.file)}})}});function h(o,m){var p=m,n=$("<canvas/>")[0],k=n.getContext("2d"),l=new Image();o.addClass("g-img-loading");l.onload=function(){var r=l.width,q=l.height,t=320,s=window.screen.availWidth;if(r>s){n.width=s;n.height=q*(s/r)}else{n.width=r;n.height=q}k.drawImage(l,0,0,n.width,n.height);o.append(n)};$(l).one("load",function(){o.removeClass("g-img-loading")});l.src=p}function d(m,q,s,n,t){var k=new Wrapper({zIndex:200,overflow:"hidden",opacity:0.8});var r=$("#J_ImageSlider").length>0?$("#J_ImageSlider"):function(){return $("body").append($('<div id="J_ImageSlider"></div>')),$("#J_ImageSlider")}();r.html("");var o=$('<div class="'+s+'"/>');o.css({paddingTop:"5%",height:"90%",width:"100%",textAlign:"center",position:"absolute",top:"0px",left:"0px",zIndex:"600"});h(o,q);var p="<p>";if(t){p+='<a href="#" class="J_Image_Del" data-fileId="'+n+'" data-cname="'+s+'">删除</a>'}p+='<a href="#" class="J_Slider_Close" data-cname="'+s+'">关闭</a>';p+="</p>";if(this.n){}o.append(p);o.find("p").css({position:"absolute",bottom:0,width:"100%"}).find("a").css({color:"#ccc",display:"inline-block",width:"35%",boxShadow:"0 0 5px #000",border:"1px solid #444",padding:"5px 0",background:"#000"});o.css({width:"100%",textAlign:"center"});r.append(o);k.show(function(){$(".J_Slider_Close").on("click",function(){r.remove();k.close()});$(".J_Image_Del").on("click",function(){var l=$(this).data("cname");$("."+l).remove();r.remove();k.close();m.config.afterDeleteImageComplete.call(m)})})}function e(m){var k=m.split(","),p=k[0].match(/:(.*?);/)[1],l=atob(k[1]),q=l.length,o=new Uint8Array(q);while(q--){o[q]=l.charCodeAt(q)}return new Blob([o],{type:p})}function b(){var k=navigator.userAgent;return k.match(/(iPad).*OS\s([\d_]+)/)||k.match(/(iPod)(.*OS\s([\d_]+))?/)||k.match(/(iPhone\sOS)\s([\d_]+)/)}function a(p,q,m){var k=0;var r=3;if(p==null){return}var s=p.height;var l=p.width;var n=2;if(n==null){n=k}if(q=="right"){n++;n>r&&(n=k)}else{n--;n<k&&(n=r)}var o=n*90*Math.PI/180;var t=m.getContext("2d");switch(n){case 0:m.width=l;m.height=s;t.drawImage(p,0,0);break;case 1:m.width=s;m.height=l;t.rotate(o);t.drawImage(p,0,-s);break;case 2:m.width=l;m.height=s;t.rotate(o);t.drawImage(p,-l,-s);break;case 3:m.width=s;m.height=l;t.rotate(o);t.drawImage(p,-l,0);break}}function f(m,k,l){var n=new Image();base64=null;n.src=k;n.onload=function(){var s="";EXIF.getData(this,function(){s=EXIF.getTag(this,"Orientation")});var p=this.naturalWidth;var r=this.naturalHeight;var q=document.createElement("canvas");var o=q.getContext("2d");q.width=p;q.height=r;o.drawImage(this,0,0,p,r);if(s!=""&&s!=1){switch(s){case 6:a(this,"left",q);break;case 8:a(this,"right",q);break;case 3:a(this,"right",q);a(this,"right",q);break}}base64=q.toDataURL("image/jpeg",m.config.qualityIOS||m.config.quality||1);l(base64)}}return new g(c,j)};